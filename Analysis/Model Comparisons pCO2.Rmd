---
title: "Model Comparisons"
author: Curtis C. Bohlen, Casco Bay Estuary Partnership
date: September 2, 2020
output:
  github_document:
    toc: true
    fig_width: 7
    fig_height: 5
---

<img
    src="https://www.cascobayestuary.org/wp-content/uploads/2014/04/logo_sm.jpg"
    style="position:absolute;top:10px;right:50px;" />


# Introduction
Because GAM models are large, I ran them in a separate Notebook, and saved them.
Here I compare models, especially to gain insight into data analysis choices and
their potential impact.

# Load Libraries
```{r}
library(tidyverse)
library(mgcv)
library(GGally)

library(CBEPgraphics)
```

# Load model results
```{r}
the_gls  <- readRDS('results/GLS.rds')
monthf   <- readRDS('results/GAM1.rds')
monthv   <- readRDS('results/GAM1.mm.rds')
doyr     <- readRDS('results/GAM1.doy.1.rds')
doyr2    <- readRDS('results/GAM1.doy.2.rds')
```

# Compare Predictions
Here we look at correlations among model results.  This is not normal
statistical practice, but since our goal is to understand which predictors are
most important, it's worth evaluating how likely it is that different models
would provide substantively different results. Perhaps it should not be
surprising that the models that are structurally similar give similar
predictions.
```{r}
preds <- tibble(
         gls    = predict(the_gls),
         monthf = predict(monthf$gam),
         monthv = predict(monthv$gam),
         doyr   = predict(doyr$gam),
         doyr2  = predict(doyr2$gam))

sum(!is.na(preds$monthf))
```

```{r}
ggpairs(preds, progress=FALSE)
```
Note also the bimodal structure to the marginal distributions of the
predictions.  That may reflect the overabundance of data from certain times of
year, but is probably the consequence of looking at the marginal distribution of
a nearly sinusoidal periodic signals.


# ANOVA Comparisons
To compare the model fits, we need to look at information criteria. Those
statistics are generated by the LME object.

```{r}
anova(doyr$lme,  monthv$lme,  doyr2$lme, monthf$lme)
```
By AIC, the best model is the one that fits a separate estimated mean for each
month.  BIC, which penalizes model complexity (here, number of parameters) a bit
more, selects the two dimensional smooth, which also has the highest log
likelihood.

I do not want to use the month by month fit, despite its goodperformance by AIC.
That model is less informative about pattern than the full two dimensional GAM
smooth model.  Besides, it disturbs me on theoretical grounds.

Why would the (essentially arbitrary) division between months matter? By
symmetry, it is possible that ANY division of the year into thirty day (or
shorter) time segments would also generate a "good" fit.   If that is the case,
the month to month parameters are essentially fitting as signal a portion of the
autocorrelation.  I am not convinced that is wise.


# GAMM Fitting DOY and Hour, with "Interaction"
## Structure of Smoothing Terms
```{r}
plot(doyr2$gam)
```
The two dimensional smoother here is difficult to interpret. The tensor
smoothers used in this model allow partitioning of the variation in a manner
akin to interaction terms in a linear model.  So the two dimensional fit is a
further adjustment AFTER fitting the main effects.  This third term here is
highly statistically significant, for what that's worth.

What it shows is a relative flattening of the diurnal fluctuations in the
spring, and relative increase in magnitude of diurnal fluctuations in the fall.
That's nice, because that pattern is clearly visible in the data. (Also, see the
seasonal graphics produced for the State of the Bay)


# Implications for Strength of Linear Association with Predictors
```{r}
summary(doyr2$gam)


```

# Preliminary Conclusions
Linear temperature, salinity, and dissolved oxygen terms in this model are all
highly statistically significant on their own (at least by the implicit "t"
test).  

* Temperature varies roughly over a range of thirty degrees C in these data.  A
rise in temperature is associated with a modest increase in pCO~2~, as expected
even only on thermodynamic grounds.  The temperature relationship alone suggests
a roughly $120 \mu \textrm Atm$ change from coldest to warmest conditions. In a
separate analysis, we developed GAMM models looking at temperature corrected
pCO~2~ values, and the temperature signal remains.  More than just
thermodynamics is at work here, probably system metabolism.

*  Salinity shows much less variation in these data, typically staying within
the range of roughly 25 to 30. As salinity goes up, so, too does pCO~2~.  It is
not clear why that should be is true.  We have come up with various hand waving
arguments, but none are convincing.

*  The negative relationship between dissolved oxygen and PCO~2~ is striking and
strong.  Dissolved oxygen at this site does not vary much, so a strong negative
relationship suggests a close physical relationship. That relationship is
evident in graphic displays as well.  A negative correlation is expected due to
stoichiometry if much of the variation in dissolved gasses is driven by system
metabolism.  On a system level, photosynthesis and decomposition are converting
CO~2~ to O~2~ and back again. While we did not pull this apart in this
preliminary analysis, the close relationship breaks down somewhat in winter,
which again one might expect since biological activity is lower when the waters
are very cold.


# Additional Analyses
Elsewhere, I have explored more complex models, by extending the GAMM framework
to incorporate alternate model specifications, including:

*  Interaction terms between the three linear predictors  
*  non-linear (spline) alternatives to the linear terms used here; and
*  Multi-dimensional (tensor product) smoothing terms.

The general conclusion has been that the linear terms are inadequate to
capture the structure in these data. Relationships are (slightly)
non-linear; relationships vary seasonally; and interactions between
predictors are often important.

# Final Comment

One hope of these analyses was to come up with some simple metrics to capture
major patterns of estuarine carbonate chemistry.  Instead, we have uncovered
tremendous complexity.  Relationships between dependent and independent
variables apparently depend crucially on context, especially location, time of day
time of year, and time of tide. It will prove difficult to identify consistent
data analytic techniques that can be applied at different monitoring locations
to identify the impact of major estuarine processes, like freshwater
influx, water column metabolism, benthic metabolism, upwelling, tidal mixing on
local carbonate chemistry.
and 






